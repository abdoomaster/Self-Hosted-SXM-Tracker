<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SXM Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 20px; }
        .modal-bg { background-color: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
        /* Console Styles */
        .console-font { font-family: 'JetBrains Mono', monospace; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-700">

    <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col z-20 shrink-0">
        <div class="p-6 border-b border-gray-100 shrink-0 flex items-center justify-center">
            <h1 class="text-xl font-bold tracking-tight text-gray-900">xmplaylist<span class="text-blue-600">.local</span></h1>
        </div>
        <div class="flex-1 overflow-y-auto custom-scroll p-4">
            <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 px-3 text-center">Genres</div>
            <nav class="space-y-1" id="genre-list"></nav>
        </div>
        <div class="p-4 border-t border-gray-100 shrink-0 bg-white">
            <button onclick="openSettings()" class="w-full flex items-center justify-center gap-2 bg-gray-50 hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg transition border border-gray-200 shadow-sm">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-white w-full">
        <header class="bg-white border-b border-gray-100 h-14 md:h-16 flex items-center justify-between px-4 md:px-8 z-10 shrink-0">
            <div class="flex items-center gap-3 md:gap-4 overflow-hidden">
                <h2 id="page-title" class="text-lg md:text-xl font-bold text-gray-800 whitespace-nowrap">All Channels</h2>
                <span id="refresh-timer" class="text-[10px] md:text-xs font-medium text-gray-400 bg-gray-50 px-2 py-1 rounded border border-gray-100 flex items-center gap-1 whitespace-nowrap">
                    <i class="fas fa-sync-alt"></i> Syncing...
                </span>
            </div>
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs md:text-sm"></i>
                <input type="text" id="search-input" class="w-32 md:w-72 pl-8 md:pl-9 pr-4 py-1.5 md:py-2 border border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition text-xs md:text-sm" placeholder="Search...">
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-white" id="main-scroll-area">
            <div id="grid-view" class="fade-in grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 md:gap-4"></div>
            
            <div id="history-view" class="max-w-7xl mx-auto hidden fade-in">
                <div class="flex flex-col gap-4 mb-6">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <button onclick="showGrid()" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm">
                                <i class="fas fa-arrow-left mr-2"></i> Back
                            </button>
                            <div>
                                <h2 class="text-xl md:text-2xl font-bold text-gray-900 leading-none" id="history-title">Channel Name</h2>
                                <p class="text-sm text-gray-500 mt-1" id="history-subtitle">Genre</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 md:gap-4 justify-between items-center bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <div class="flex items-center gap-2">
                            <div class="flex bg-white p-1 rounded-md border border-gray-200">
                                <button onclick="setSort('latest')" id="btn-sort-latest" class="px-3 py-1 text-xs font-bold rounded shadow-sm bg-gray-100 text-gray-900 transition">Newest</button>
                                <button onclick="setSort('count')" id="btn-sort-count" class="px-3 py-1 text-xs font-bold rounded text-gray-500 hover:text-gray-900 transition">Most Played</button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex bg-white p-1 rounded-md border border-gray-200">
                                <button onclick="setFilter('all')" id="btn-filter-all" class="px-3 py-1 text-xs font-bold rounded shadow-sm bg-gray-100 text-gray-900 transition">All</button>
                                <button onclick="setFilter('owned')" id="btn-filter-owned" class="px-3 py-1 text-xs font-bold rounded text-gray-500 hover:text-gray-900 transition text-green-600">Owned</button>
                                <button onclick="setFilter('missing')" id="btn-filter-missing" class="px-3 py-1 text-xs font-bold rounded text-gray-500 hover:text-gray-900 transition text-red-500">Missing</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="history-desc-box" class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6 text-blue-800 text-sm leading-relaxed text-center"></div>
                <div id="song-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4"></div>
            </div>
        </div>
    </main>

    <button onclick="toggleConsole()" class="fixed bottom-6 right-6 w-12 h-12 bg-gray-900 hover:bg-black text-white rounded-full shadow-xl flex items-center justify-center transition-all z-40 border-2 border-gray-700">
        <i class="fas fa-terminal"></i>
    </button>

    <div id="console-modal" class="fixed inset-x-0 bottom-0 h-96 bg-gray-900 z-50 transform translate-y-full transition-transform duration-300 ease-in-out shadow-2xl border-t border-gray-700 flex flex-col">
        <div class="flex justify-between items-center px-4 py-2 bg-gray-800 border-b border-gray-700">
            <span class="text-gray-400 text-xs font-mono uppercase tracking-widest"><i class="fas fa-circle text-green-500 text-[8px] mr-2"></i>Live System Logs</span>
            <button onclick="toggleConsole()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div id="console-output" class="flex-1 overflow-y-auto p-4 console-font text-xs md:text-sm space-y-1 bg-[#0d1117] custom-scroll">
            </div>
    </div>

    <div id="song-overlay" class="fixed inset-0 z-50 hidden flex justify-end modal-bg">
        <div class="w-full md:max-w-xl bg-white h-full shadow-2xl overflow-y-auto p-6 md:p-8 flex flex-col slide-in border-l border-gray-200">
            <button onclick="closeSongDetail()" class="self-end text-gray-400 hover:text-gray-800 mb-4 p-2"><i class="fas fa-times text-2xl"></i></button>
            <div class="text-center mb-8">
                <div class="text-xs text-gray-400 mb-3 uppercase tracking-widest font-bold"><span id="detail-station-name">Station</span></div>
                <img id="detail-art" src="" class="w-40 h-40 md:w-56 md:h-56 mx-auto rounded-xl shadow-lg mb-6 object-cover bg-gray-100 border border-gray-100">
                <h1 id="detail-title" class="text-xl md:text-2xl font-bold text-gray-900 mb-2 leading-tight">Title</h1>
                <h2 id="detail-artist" class="text-base md:text-lg text-gray-500 font-medium">Artist</h2>
            </div>
            <div id="detail-links-container" class="grid grid-cols-2 gap-3 mb-8"></div>
            <div class="grid grid-cols-3 gap-3 md:gap-4 mb-8">
                <div class="bg-gray-50 p-3 md:p-4 rounded-xl text-center border border-gray-100"><div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Rank</div><div id="stat-rank" class="text-lg md:text-xl font-bold text-gray-800">#--</div></div>
                <div class="bg-gray-50 p-3 md:p-4 rounded-xl text-center border border-gray-100"><div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Total Plays</div><div id="stat-plays-total" class="text-lg md:text-xl font-bold text-blue-600">--</div></div>
                <div class="bg-gray-50 p-3 md:p-4 rounded-xl text-center border border-gray-100"><div class="text-[10px] text-gray-400 uppercase font-bold mb-1">30 Days</div><div id="stat-plays-30" class="text-lg md:text-xl font-bold text-gray-800">--</div></div>
            </div>
            <div class="mb-8 bg-white p-4 border border-gray-100 rounded-xl relative h-48"><div class="h-full w-full"><canvas id="playsChart"></canvas></div></div>
            <div class="bg-gray-50 rounded-xl p-6 border border-gray-100"><h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 text-center">Recent History</h3><div id="recent-plays-list" class="space-y-3 text-sm text-gray-600"></div></div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden modal-bg flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h2 class="text-xl font-bold text-gray-900">Settings</h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 md:p-8">
                <form id="settings-form" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h3 class="text-sm font-bold uppercase text-gray-400 tracking-wider border-b border-gray-100 pb-2">Navidrome & Downloads</h3>
                            <div><label class="block text-sm font-medium text-gray-700">URL</label><input type="text" id="set-nd-url" class="mt-1 w-full border border-gray-300 rounded-md p-2"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Username</label><input type="text" id="set-nd-user" class="mt-1 w-full border border-gray-300 rounded-md p-2"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="set-nd-pass" class="mt-1 w-full border border-gray-300 rounded-md p-2"></div>
                            </div>
                            <div class="flex flex-col gap-2 mt-2">
                                <div class="flex items-center gap-2"><input type="checkbox" id="set-sync-pl" class="h-4 w-4 text-blue-600 rounded"><label for="set-sync-pl" class="text-sm font-medium text-gray-700">Auto-create Playlists</label></div>
                                <div class="flex items-center gap-2"><input type="checkbox" id="set-enable-dl" class="h-4 w-4 text-blue-600 rounded"><label for="set-enable-dl" class="text-sm font-medium text-gray-700">Enable Downloads (Slskd)</label></div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="text-sm font-bold uppercase text-gray-400 tracking-wider border-b border-gray-100 pb-2">Maintenance</h3>
                             <div class="bg-orange-50 border border-orange-100 rounded-lg p-4">
                                <h4 class="text-sm font-bold text-orange-800 mb-2">Sync Playlists</h4>
                                <p class="text-xs text-orange-600 mb-3">Force add all "Owned" songs from history to Navidrome playlists. Useful if you missed some syncs.</p>
                                <button type="button" onclick="syncPlaylists()" class="w-full bg-orange-100 hover:bg-orange-200 text-orange-800 font-bold py-2 px-4 rounded border border-orange-200 transition text-sm"><i class="fas fa-sync-alt mr-2"></i> Force Sync All</button>
                            </div>
                            <h3 class="text-sm font-bold uppercase text-gray-400 tracking-wider border-b border-gray-100 pb-2 mt-6">System</h3>
                            <div><label class="block text-sm font-medium text-gray-700">FlareSolverr URL</label><input type="text" id="set-fs-url" class="mt-1 w-full border border-gray-300 rounded-md p-2"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Interval (s)</label><input type="number" id="set-interval" class="mt-1 w-full border border-gray-300 rounded-md p-2"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Workers</label><input type="number" id="set-workers" class="mt-1 w-full border border-gray-300 rounded-md p-2"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold uppercase text-gray-400 tracking-wider border-b border-gray-100 pb-2 mb-4">Tracked Channels</h3>
                        <div class="mb-4"><input type="text" id="channel-search" placeholder="Filter channels..." class="w-full border border-gray-300 rounded-md p-2" onkeyup="filterSettingsChannels()"></div>
                        <div id="settings-channel-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-64 overflow-y-auto custom-scroll p-1"></div>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeSettings()" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg font-medium">Cancel</button>
                <button onclick="saveSettings()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-sm">Save</button>
            </div>
        </div>
    </div>

    <script>
        const META_URL = '/data/channels.json';
        const SETTINGS_URL = '/settings';
        const SYNC_PLAYLISTS_URL = '/settings/sync-playlists'; 
        
        let CHANNEL_META = {};
        let CURRENT_SETTINGS = {};
        let currentChannelSlug = null;
        let currentChannelData = {}; 
        let charts = {}; 
        let lastUpdated = new Date();
        let sortBy = 'latest';
        let activeGenre = 'All';
        let filterBy = 'all'; 

        // Console state
        let consoleOpen = false;
        let consoleInterval = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setInterval(refreshData, 10000);
            setInterval(updateTimerUI, 1000);
            document.getElementById('search-input').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (currentChannelSlug) renderSongList();
                else renderGrid(query);
            });
        });

        function toggleConsole() {
            const el = document.getElementById('console-modal');
            consoleOpen = !consoleOpen;
            if(consoleOpen) {
                el.classList.remove('translate-y-full');
                fetchLogs();
                consoleInterval = setInterval(fetchLogs, 2000);
            } else {
                el.classList.add('translate-y-full');
                if(consoleInterval) clearInterval(consoleInterval);
            }
        }

        async function fetchLogs() {
            try {
                const res = await fetch('/logs');
                const logs = await res.json();
                const container = document.getElementById('console-output');
                container.innerHTML = logs.map(l => {
                    let color = 'text-gray-400';
                    let icon = '';
                    if(l.level === 'error') { color = 'text-red-400'; icon = '‚ùå '; }
                    else if(l.level === 'download') { color = 'text-blue-400'; icon = '‚¨áÔ∏è '; }
                    else if(l.level === 'success') { color = 'text-green-400'; icon = '‚úÖ '; }
                    else if(l.level === 'search') { color = 'text-purple-400'; icon = 'üîé '; }
                    else if(l.level === 'new') { color = 'text-yellow-400'; icon = 'üéµ '; }
                    
                    return `<div class="font-mono ${color}"><span class="opacity-50 mr-2">[${l.ts}]</span>${icon}${l.msg}</div>`;
                }).join('');
                // Auto scroll to bottom
                container.scrollTop = container.scrollHeight;
            } catch(e) {}
        }

        function updateTimerUI() {
            const diff = Math.floor((new Date() - lastUpdated) / 1000);
            document.getElementById('refresh-timer').innerHTML = `<i class="fas fa-sync-alt"></i> ${diff}s ago`;
        }

        async function loadData() {
            try {
                const metaRes = await fetch(META_URL + '?t=' + Date.now());
                CHANNEL_META = await metaRes.json();
                try {
                    const setRes = await fetch(SETTINGS_URL);
                    CURRENT_SETTINGS = await setRes.json();
                } catch(e) {}
                renderGrid();
                renderGenres();
            } catch (e) { console.error(e); }
        }

        async function refreshData() {
            if (currentChannelSlug) {
                try {
                    const res = await fetch(`/data/history/${currentChannelSlug}.json?t=` + Date.now());
                    currentChannelData = await res.json();
                    renderSongList();
                    lastUpdated = new Date();
                } catch(e) {}
            }
        }

        function renderGrid(query = "") {
            const grid = document.getElementById('grid-view');
            grid.innerHTML = '';
            const trackedSlugs = Object.keys(CHANNEL_META).filter(slug => CHANNEL_META[slug].is_tracked);
            if (trackedSlugs.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-12 text-gray-400"><i class="fas fa-satellite-dish text-4xl mb-3"></i><p>No channels tracked. Go to Settings to add some!</p></div>`;
                return;
            }
            const filteredSlugs = trackedSlugs.filter(slug => {
                if(!query) return true;
                const meta = CHANNEL_META[slug];
                return meta.name.toLowerCase().includes(query) || meta.number.includes(query);
            });
            const genreSlugs = filteredSlugs.filter(slug => {
                if(activeGenre === 'All') return true;
                return CHANNEL_META[slug].genre === activeGenre;
            });
            genreSlugs.forEach(slug => {
                const meta = CHANNEL_META[slug];
                const logoUrl = `/data/logos/${slug}.png`;
                const card = document.createElement('div');
                card.className = `relative flex flex-col items-center justify-between bg-white border border-gray-200 rounded-xl p-3 sm:p-4 aspect-[10/9] transition-all duration-200 hover:shadow-lg hover:border-blue-400 cursor-pointer group select-none`;
                card.onclick = () => showHistory(slug);
                card.innerHTML = `
                    <div class="absolute top-2 right-2 sm:top-3 sm:right-3 text-[10px] sm:text-xs font-medium text-gray-400 group-hover:text-blue-500 transition-colors">${meta.number}</div>
                    <div class="flex-1 w-full flex items-center justify-center mt-2 mb-1">
                        <img src="${logoUrl}" class="max-h-[60%] w-auto max-w-full object-contain transition-transform duration-200 group-hover:scale-105" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" alt="${meta.name}">
                        <div class="w-16 h-16 sm:w-20 sm:h-20 ${meta.bg} rounded-full flex items-center justify-center shadow-inner ring-4 ring-white hidden"><span class="${meta.color} font-black text-center text-xs sm:text-sm px-1 uppercase">${meta.short}</span></div>
                    </div>
                    <div class="w-full text-center"><h3 class="text-xs sm:text-sm font-semibold text-gray-700 truncate group-hover:text-blue-600 transition-colors leading-tight" title="${meta.name}">${meta.name}</h3></div>
                `;
                grid.appendChild(card);
            });
        }

        function showHistory(slug) {
            currentChannelSlug = slug;
            const meta = CHANNEL_META[slug];
            document.getElementById('grid-view').classList.add('hidden');
            document.getElementById('history-view').classList.remove('hidden');
            document.getElementById('history-title').innerText = meta.name;
            document.getElementById('history-subtitle').innerText = meta.genre;
            document.getElementById('history-desc-box').innerText = meta.long_desc || meta.desc || "No description available.";
            document.getElementById('search-input').value = '';
            refreshData();
        }

        function showGrid() {
            currentChannelSlug = null;
            document.getElementById('history-view').classList.add('hidden');
            document.getElementById('grid-view').classList.remove('hidden');
            document.getElementById('search-input').value = '';
            renderGrid();
        }

        function setSort(type) {
            sortBy = type;
            document.getElementById('btn-sort-count').className = type === 'count' ? "px-3 py-1 text-xs font-bold rounded shadow-sm bg-white text-gray-900 transition" : "px-3 py-1 text-xs font-bold rounded text-gray-500 hover:text-gray-900 transition";
            document.getElementById('btn-sort-latest').className = type === 'latest' ? "px-3 py-1 text-xs font-bold rounded shadow-sm bg-white text-gray-900 transition" : "px-3 py-1 text-xs font-bold rounded text-gray-500 hover:text-gray-900 transition";
            renderSongList();
        }

        function setFilter(type) {
            filterBy = type;
            const btnAll = document.getElementById('btn-filter-all');
            const btnOwned = document.getElementById('btn-filter-owned');
            const btnMissing = document.getElementById('btn-filter-missing');
            const baseClass = "px-3 py-1 text-xs font-bold rounded text-gray-500 hover:text-gray-900 transition";
            btnAll.className = baseClass;
            btnOwned.className = "px-3 py-1 text-xs font-bold rounded text-gray-500 hover:text-gray-900 transition text-green-600";
            btnMissing.className = "px-3 py-1 text-xs font-bold rounded text-gray-500 hover:text-gray-900 transition text-red-500";
            if(type === 'all') btnAll.className = "px-3 py-1 text-xs font-bold rounded shadow-sm bg-white text-gray-900 transition";
            else if(type === 'owned') btnOwned.className = "px-3 py-1 text-xs font-bold rounded shadow-sm bg-white text-green-700 transition";
            else if(type === 'missing') btnMissing.className = "px-3 py-1 text-xs font-bold rounded shadow-sm bg-white text-red-700 transition";
            renderSongList();
        }

        function renderSongList() {
            const list = document.getElementById('song-list');
            list.innerHTML = '';
            const songs = Object.values(currentChannelData);
            let processed = [];
            if (sortBy === 'count') {
                const grouped = {};
                songs.forEach(s => {
                    const key = s.title + s.artist;
                    if (!grouped[key]) grouped[key] = { ...s, count: 0, last_played: s.timestamp };
                    grouped[key].count++;
                    if (new Date(s.timestamp) > new Date(grouped[key].last_played)) grouped[key].last_played = s.timestamp;
                });
                processed = Object.values(grouped).sort((a,b) => b.count - a.count);
            } else {
                processed = songs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            }
            const query = document.getElementById('search-input').value.toLowerCase();
            if(query) processed = processed.filter(s => s.title.toLowerCase().includes(query) || s.artist.toLowerCase().includes(query));
            if (filterBy === 'owned') processed = processed.filter(s => s.navidrome_id || s.download_status === 'downloaded');
            if (filterBy === 'missing') processed = processed.filter(s => !s.navidrome_id && s.download_status !== 'downloaded');
            processed.forEach(s => {
                const art = s.album_art || 'https://placehold.co/64x64?text=No+Art';
                let dateObj = new Date(s.last_played || s.timestamp);
                if (isNaN(dateObj.getTime())) dateObj = new Date(); 
                const timeString = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const linkUrl = (s.links && s.links.length > 0) ? s.links[0].url : `https://open.spotify.com/search/${encodeURIComponent(s.title + ' ' + s.artist)}`;
                let statusBadge = '';
                if(s.navidrome_id || s.download_status === 'downloaded') statusBadge = `<span class="text-[10px] font-bold text-green-600 bg-green-50 px-2 py-1 rounded border border-green-100"><i class="fas fa-check mr-1"></i> OWNED</span>`;
                else if (s.download_status === 'failed') statusBadge = `<span class="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded border border-red-100">FAILED</span>`;
                else statusBadge = `<span class="text-[10px] font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded border border-gray-200">MISSING</span>`;
                
                const card = document.createElement('div');
                card.className = "song-card bg-white rounded-xl p-3 sm:p-4 flex gap-3 sm:gap-4 items-start border border-gray-200 hover:border-blue-300 transition-all shadow-sm";
                card.onclick = (e) => { if(!e.target.closest('button') && !e.target.closest('a')) openSongDetailFromCard(s); };
                card.innerHTML = `
                    <img src="${art}" class="w-16 h-16 sm:w-20 sm:h-20 rounded-lg object-cover border border-gray-100 flex-shrink-0">
                    <div class="flex-1 min-w-0 flex flex-col h-full justify-between">
                        <div class="mb-1">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] sm:text-xs text-gray-400 font-medium">${timeAgo(dateObj)} ‚Ä¢ ${timeString}</span>
                                <div class="flex items-center gap-2">${statusBadge}</div>
                            </div>
                            <h4 class="text-gray-900 font-bold text-sm sm:text-base truncate leading-tight" title="${s.title}">${s.title}</h4>
                            <p class="text-gray-500 text-xs sm:text-sm truncate" title="${s.artist}">${s.artist}</p>
                        </div>
                        <div class="flex gap-2 mt-auto" id="actions-${s.id || Math.random().toString(36).substr(2, 9)}"></div>
                    </div>`;
                const infoBtn = document.createElement('button');
                infoBtn.className = "flex-1 bg-gray-50 hover:bg-white text-gray-600 hover:text-blue-600 text-[10px] sm:text-xs font-bold py-1.5 rounded border border-gray-200 transition";
                infoBtn.innerHTML = '<i class="fas fa-info-circle"></i> Info';
                infoBtn.onclick = (e) => { e.stopPropagation(); openSongDetailFromCard(s); };
                const listenBtn = document.createElement('a');
                listenBtn.className = "flex-1 bg-gray-50 hover:bg-white text-gray-600 hover:text-green-600 text-[10px] sm:text-xs font-bold py-1.5 rounded border border-gray-200 transition text-center";
                listenBtn.innerHTML = '<i class="fas fa-play"></i> Play';
                listenBtn.href = linkUrl;
                listenBtn.target = "_blank";
                listenBtn.onclick = (e) => e.stopPropagation();
                const actionsDiv = card.querySelector(`div[id^="actions-"]`);
                if(actionsDiv) { actionsDiv.appendChild(infoBtn); actionsDiv.appendChild(listenBtn); }
                list.appendChild(card);
            });
        }

        function openSongDetailFromCard(songData) {
            const allInstances = Object.values(currentChannelData).filter(s => s.title === songData.title && s.artist === songData.artist);
            const aggregated = { ...songData, count: allInstances.length };
            openSongDetail(aggregated);
        }

        function openSongDetail(song) {
            document.getElementById('song-overlay').classList.remove('hidden');
            const meta = CHANNEL_META[currentChannelSlug];
            document.getElementById('detail-station-name').innerText = meta ? meta.name : 'Unknown Station';
            document.getElementById('detail-title').innerText = song.title;
            document.getElementById('detail-artist').innerText = song.artist;
            document.getElementById('detail-art').src = song.album_art || 'https://placehold.co/300x300?text=No+Art';
            const container = document.getElementById('detail-links-container');
            container.innerHTML = '';
            const links = song.links || [];
            const createLinkBtn = (site, url, iconClass, colorClass) => `<a href="${url}" target="_blank" class="flex items-center justify-center gap-2 py-3 rounded-lg border border-gray-200 ${colorClass} transition text-sm font-bold"><i class="${iconClass} text-lg"></i> ${site}</a>`;
            const spotifyLink = links.find(l => l.site === 'spotify')?.url || `https://open.spotify.com/search/${encodeURIComponent(song.title + ' ' + song.artist)}`;
            container.innerHTML += createLinkBtn('Spotify', spotifyLink, 'fab fa-spotify', 'hover:bg-green-50 hover:text-green-700 text-gray-600');
            const ytLink = links.find(l => l.site === 'youtube')?.url || `https://www.youtube.com/results?search_query=${encodeURIComponent(song.title + ' ' + song.artist)}`;
            container.innerHTML += createLinkBtn('YouTube', ytLink, 'fab fa-youtube', 'hover:bg-red-50 hover:text-red-600 text-gray-600');
            const plays = [];
            Object.values(currentChannelData).forEach(s => { if(s.title === song.title && s.artist === song.artist) plays.push(new Date(s.timestamp)); });
            plays.sort((a, b) => b - a);
            const total = plays.length;
            const now = new Date();
            const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(now.getDate() - 30);
            const plays30 = plays.filter(d => d >= thirtyDaysAgo).length;
            document.getElementById('stat-plays-total').innerText = total;
            document.getElementById('stat-plays-30').innerText = plays30;
            const leaderboard = {};
            Object.values(currentChannelData).forEach(s => { const key = s.title + s.artist; leaderboard[key] = (leaderboard[key] || 0) + 1; });
            const scores = Object.values(leaderboard).sort((a,b) => b-a);
            const myScore = leaderboard[song.title + song.artist];
            const rank = scores.indexOf(myScore) + 1;
            document.getElementById('stat-rank').innerText = `#${rank}`;
            const list = document.getElementById('recent-plays-list');
            list.innerHTML = '';
            plays.slice(0, 10).forEach(date => {
                const div = document.createElement('div');
                div.className = "flex justify-between border-b border-gray-200 pb-2 last:border-0";
                div.innerHTML = `<span>${timeAgo(date)}</span> <span class="font-mono text-gray-400 text-xs">${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;
                list.appendChild(div);
            });
            renderChart(plays);
        }

        function renderChart(plays) {
            const ctx = document.getElementById('playsChart').getContext('2d');
            if (charts['plays']) charts['plays'].destroy();
            const weeks = new Array(15).fill(0);
            const labels = [];
            for(let i=14; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - (i * 7));
                labels.push(`${d.getMonth()+1}/${d.getDate()}`);
            }
            const now = new Date();
            plays.forEach(d => {
                const diffTime = now - d;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const weekIndex = Math.floor(diffDays / 7);
                if (weekIndex >= 0 && weekIndex < 15) weeks[14 - weekIndex]++;
            });
            charts['plays'] = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Plays', data: weeks, backgroundColor: '#3b82f6', borderRadius: 4, barPercentage: 0.6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 }, grid: { borderDash: [2, 4], color: '#f3f4f6' } }, x: { grid: { display: false } } } }
            });
        }

        function closeSongDetail() { document.getElementById('song-overlay').classList.add('hidden'); }

        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('set-nd-url').value = CURRENT_SETTINGS.nd_url || '';
            document.getElementById('set-nd-user').value = CURRENT_SETTINGS.nd_user || '';
            document.getElementById('set-fs-url').value = CURRENT_SETTINGS.flaresolverr_url || '';
            document.getElementById('set-interval').value = CURRENT_SETTINGS.fetch_interval || 60;
            document.getElementById('set-workers').value = CURRENT_SETTINGS.max_workers || 3;
            document.getElementById('set-sync-pl').checked = CURRENT_SETTINGS.sync_playlists || false;
            document.getElementById('set-enable-dl').checked = CURRENT_SETTINGS.enable_downloads || false;
            const list = document.getElementById('settings-channel-list');
            list.innerHTML = '';
            Object.values(CHANNEL_META).sort((a,b) => parseInt(a.number) - parseInt(b.number)).forEach(ch => {
                const div = document.createElement('div');
                div.className = "flex items-center p-2 border border-gray-200 rounded hover:bg-gray-50";
                div.innerHTML = `<input type="checkbox" id="ch-${ch.slug}" value="${ch.slug}" ${ch.is_tracked ? 'checked' : ''} class="mr-2 h-4 w-4 text-blue-600 rounded"><label for="ch-${ch.slug}" class="text-sm text-gray-700 truncate flex-1 cursor-pointer"><span class="font-bold text-gray-400 mr-1">${ch.number}</span> ${ch.name}</label>`;
                list.appendChild(div);
            });
        }

        function filterSettingsChannels() {
            const q = document.getElementById('channel-search').value.toLowerCase();
            const items = document.getElementById('settings-channel-list').children;
            for (let item of items) { item.style.display = item.innerText.toLowerCase().includes(q) ? 'flex' : 'none'; }
        }

        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

        async function syncPlaylists() {
            if(!confirm("This will scan all your channel history and add ANY 'Owned' songs to their respective Navidrome playlists. This may take a while. Continue?")) return;
            try {
                const res = await fetch(SYNC_PLAYLISTS_URL, { method: 'POST' });
                const data = await res.json();
                alert(data.message);
            } catch(e) { alert("Error triggering playlist sync: " + e); }
        }

        async function saveSettings() {
            const checkboxes = document.querySelectorAll('#settings-channel-list input:checked');
            const tracked = Array.from(checkboxes).map(cb => cb.value);
            const newSettings = {
                ...CURRENT_SETTINGS,
                nd_url: document.getElementById('set-nd-url').value,
                nd_user: document.getElementById('set-nd-user').value,
                flaresolverr_url: document.getElementById('set-fs-url').value,
                fetch_interval: parseInt(document.getElementById('set-interval').value),
                max_workers: parseInt(document.getElementById('set-workers').value),
                sync_playlists: document.getElementById('set-sync-pl').checked,
                enable_downloads: document.getElementById('set-enable-dl').checked,
                tracked_channels: tracked
            };
            try {
                const res = await fetch(SETTINGS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newSettings) });
                if(res.ok) { alert("Settings Saved Successfully!"); closeSettings(); loadData(); } else { alert("Error saving settings"); }
            } catch(e) { alert("Failed to save settings."); }
        }

        function renderGenres() {
            const list = document.getElementById('genre-list');
            list.innerHTML = '';
            const genres = new Set(['All']);
            Object.values(CHANNEL_META).forEach(m => { if(m.genre) genres.add(m.genre); });
            genres.forEach(g => {
                const item = document.createElement('a');
                const isActive = (g === activeGenre);
                const baseClass = "block px-3 py-2 rounded-md text-sm font-medium cursor-pointer transition text-center";
                item.className = isActive ? `${baseClass} bg-blue-50 text-blue-700 font-bold` : `${baseClass} text-gray-600 hover:bg-gray-50 hover:text-gray-900`;
                item.innerText = g;
                item.onclick = () => { activeGenre = g; if(currentChannelSlug) showGrid(); renderGrid(); renderGenres(); }; 
                list.appendChild(item);
            });
        }

        function timeAgo(ts) {
            const date = ts instanceof Date ? ts : new Date(ts);
            if (isNaN(date.getTime())) return 'Just now'; 
            const s = Math.floor((new Date() - date) / 1000);
            if (s < 60) return 'Just now';
            if (s < 3600) return Math.floor(s/60) + 'm ago';
            return Math.floor(s/3600) + 'h ago';
        }
    </script>
</body>
</html>
